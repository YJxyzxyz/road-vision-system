# Road Vision System

#### author:YJxyzxyz

<img src="https://github.com/YJxyzxyz/road-vision-system/blob/master/logo.png" width="350px">

------

# æ€»ä½“æ¨¡å—è·¯çº¿å›¾

1. **Module 1ï¼šè§†é¢‘é‡‡é›†ä¸æ—¶é—´æˆ³**ï¼ˆè¾“å…¥æºã€åˆ†è¾¨ç‡ã€å¸§ç‡ã€ç²¾å‡†æ—¶é—´ï¼‰
2. **Module 2ï¼šå›¾åƒé¢„å¤„ç†æ’ä»¶æ¡†æ¶**ï¼ˆå ä½ï¼šå»é›¾/å»é›¨å¯ç‹¬ç«‹å¼€å…³ä¸ä¸²æ¥ï¼‰
3. **Module 3ï¼šè½¦è¾†æ£€æµ‹æ¥å£**ï¼ˆç»Ÿä¸€è¿”å›æ ¼å¼ï¼Œåç«¯å¯æ›¿æ¢ï¼šYOLO/TensorRTï¼‰
4. **Module 4ï¼šè½»é‡è·Ÿè¸ªï¼ˆIDç»´æŒï¼‰**
5. **Module 5ï¼šå•ç›®æµ‹è·ï¼ˆç›¸æœºæ ‡å®šâ†’å‡ ä½•æµ‹è·ï¼‰**
6. **Module 6ï¼šé€Ÿåº¦ä¼°è®¡ï¼ˆå¸§æ—¶é—´å·® + å¹³æ»‘ï¼‰**
7. **Module 7ï¼šå¯è§†åŒ–ä¸å‘Šè­¦**
8. **Module 8ï¼šæ€§èƒ½ä¸å¼‚æ­¥æµæ°´çº¿ï¼ˆå¤šçº¿ç¨‹/è·³å¸§/é…ç½®çƒ­åˆ‡æ¢ï¼‰**
9. **Module 9ï¼šJetson Nano éƒ¨ç½²æ›¿æ¢å±‚ï¼ˆç›¸æœº/GStreamerï¼ŒTensorRTæ¨ç†ï¼‰**

------

# Module 1ï¼ˆè§†é¢‘é‡‡é›†ä¸æ—¶é—´æˆ³ï¼‰

## âœ… ç›®æ ‡

- ä»æ‘„åƒå¤´/è§†é¢‘æ–‡ä»¶**ç¨³å®šæ‹¿å¸§**
- æ¯å¸§é™„å¸¦**æ•è·æ—¶é—´æˆ³**ï¼ˆç§’ï¼Œfloatï¼‰ï¼Œä¸è¦ç”¨â€œä¼°è®¡å¸§ç‡â€
- å¯é…ç½®åˆ†è¾¨ç‡ä¸å¸§ç‡ï¼›ç»Ÿè®¡**å®é™…FPS**ï¼ˆæ»‘åŠ¨å¹³å‡ï¼‰

## ğŸ“ ç›®å½•&æ–‡ä»¶ï¼ˆæœ€å°éª¨æ¶ï¼‰

```
roadvision/
  configs/
    default.yaml
  src/
    __init__.py
    config.py
    io_video/
      __init__.py
      capture.py
      fps_meter.py
  main_preview.py
```

------

# Module 2.1ï¼ˆå›¾åƒé¢„å¤„ç†æ’ä»¶æ¡†æ¶ï¼‰

## âœ… ç›®æ ‡

- ä¼ ç»Ÿæ–¹æ³•å®ç°
- åœ¨é…ç½®é‡Œå¼€/å…³ä¸è°ƒæ•´å‚æ•°ï¼Œé»˜è®¤é›¶ä¾µå…¥ï¼ˆä¸å¼€ä¹Ÿä¸å½±å“ä¸»æµç¨‹ï¼‰
- åé¢æ¢æˆæ›´å¼ºçš„å»é›¾/å»é›¨ CNN ä¹Ÿåªéœ€æ›¿æ¢åŒåæ’ä»¶å³å¯ã€‚
- åŒæ—¶æ”¯æŒcpuå’Œgpuä¸¤ç§æ–¹å¼

## ğŸ“ ç›®å½•&æ–‡ä»¶ï¼ˆæœ€å°éª¨æ¶ï¼‰

ä¿®æ”¹è°ƒå‚è¯´æ˜

**é»˜è®¤å¼€é“¾**ï¼ˆ`preprocess.enabled: true`ï¼‰ï¼Œç”»é¢å¯¹æ¯”åº¦åº”æ›´æ¸…æ™°ï¼ˆCLAHEï¼‰ï¼Œç»†é›¨å™ªç‚¹ç•¥å¼±ï¼ˆMedianï¼‰ã€‚

å…³é“¾ï¼šæŠŠ `enabled: false` å¯¹æ¯”æ€§èƒ½ä¸è§†è§‰å·®å¼‚ã€‚

æ”¹ `CLAHEDehaze.params`ï¼š

- `space: "LAB"` å¾€å¾€åâ€œè‡ªç„¶â€ï¼Œ`"YCrCb"`åâ€œé”â€ï¼›
- `clip_limit` 
- `tile_grid` è¶Šå¤§å—å¯¹æ¯”åº¦è‡ªé€‚åº”è¶Šç»†è…»ï¼Œä½†å¼€é”€ç•¥å¢ã€‚

æ”¹ `MedianDerain.params.ksize` ä¸º 5 çœ‹â€œå»çº¹ç†â€çš„åŠ›åº¦ï¼ˆè¿‡å¤§ä¼šç³Šï¼‰ã€‚

------

# Module 3ï¼ˆè½¦è¾†æ£€æµ‹æ¥å£ï¼‰

## âœ… ç›®æ ‡

- ç»Ÿä¸€çš„æ£€æµ‹è¾“å‡º `Detection` æ•°æ®ç»“æ„ï¼Œåç«¯å¯æ›¿æ¢ï¼ˆUltralytics/ONNX/TensorRTï¼‰ã€‚
- åœ¨é…ç½®ä¸­æ§åˆ¶æ¨¡å‹è·¯å¾„ã€ç±»åˆ«ç­›é€‰ã€é˜ˆå€¼ã€‚
- ç»“æœç›´æ¥ä¼ é€’ç»™åç»­çš„è·Ÿè¸ªã€æµ‹è·ã€å¯è§†åŒ–æ¨¡å—ã€‚

## âš™ï¸ ä½¿ç”¨æ–¹æ³•

- é»˜è®¤ `configs/default.yaml` ä¸­å¼€å¯ YOLOv8n æ£€æµ‹ï¼š

  ```yaml
  detect:
    enabled: true
    model: "yolov8n.pt"
    classes_keep: [0, 2, 3, 5, 7]
  ```

- è‹¥éœ€è¦åˆ‡æ¢æ¨¡å‹æˆ–è®¾å¤‡ï¼Œä¿®æ”¹ `model`ã€`device`ã€`conf_thres` ç­‰å­—æ®µå³å¯ã€‚

------

# Module 4 / 5 / 6ï¼ˆè·Ÿè¸ª + æµ‹è· + é€Ÿåº¦ä¼°è®¡ï¼‰

## âœ… æ–°å¢èƒ½åŠ›

- å†…ç½® SORT è·Ÿè¸ªå™¨ï¼Œè‡ªåŠ¨ç»´æŒç›®æ ‡ IDï¼Œæ”¯æŒ Kalman é¢„æµ‹ä¸ IoU åŒ¹é…ã€‚
- `Detection` ç»“æ„æ–°å¢ `track_id`ã€`distance_m`ã€`speed_kmh` å­—æ®µï¼Œä¸²è”æµ‹è·ä¸é€Ÿåº¦ä¼°è®¡ã€‚
- åœ¨çœŸå®æ—¶é—´æˆ³é©±åŠ¨ä¸‹ï¼Œæ ¹æ®åœ°é¢åæ ‡è½¨è¿¹çª—å£è®¡ç®—ç›®æ ‡ç¬æ—¶é€Ÿåº¦ã€‚

## âš™ï¸ å¿«é€Ÿä¸Šæ‰‹

1. **å¯ç”¨è·Ÿè¸ªå™¨**ï¼ˆé»˜è®¤å·²å¼€ï¼‰ï¼š

   ```yaml
   tracking:
     enabled: true
     backend: "sort"
     max_staleness: 1.2
     min_hits: 3
     iou_threshold: 0.35
     speed_window: 0.8
   ```

2. **é…ç½®åœ°é¢æŠ•å½±**ï¼ˆè‹¥éœ€è·ç¦»/é€Ÿåº¦ï¼‰ï¼š

   ```yaml
   geometry:
     enabled: true
     projector:
       type: "homography"
       image_points: [[x1, y1], [x2, y2], [x3, y3], [x4, y4]]
       world_points: [[X1, Y1], [X2, Y2], [X3, Y3], [X4, Y4]]
       origin: [0.0, 0.0]
       max_distance: 1000.0
   ```

   - `image_points` ä¸ºå›¾åƒåƒç´ ï¼ˆé€šå¸¸å–è·¯é¢å››è§’/è½¦é“çº¿äº¤ç‚¹ï¼‰ã€‚
   - `world_points` å¯¹åº”å®é™…åœ°é¢åæ ‡ï¼ˆå•ä½ï¼šç±³ï¼‰ï¼Œéœ€ä¸åƒç´ ç‚¹ä¸€ä¸€å¯¹åº”ã€‚
   - `origin` å®šä¹‰è·ç¦»çš„èµ·ç‚¹ï¼ˆä¾‹å¦‚ç›¸æœºæŠ•å½±åœ¨åœ°é¢çš„åæ ‡ï¼‰ã€‚

3. **ç»“æœæŸ¥çœ‹**ï¼šä¸»å¾ªç¯ä¸­ä¼šä¸ºæ¯ä¸ªç›®æ ‡å åŠ  `ID | ç±»åˆ« | ç½®ä¿¡åº¦` ä»¥åŠåº•éƒ¨çš„ `è·ç¦» / é€Ÿåº¦` ä¿¡æ¯ã€‚

> ğŸ“Œ è‹¥æš‚æœªå®Œæˆæ ‡å®šï¼Œå¯ä»…å¼€å¯è·Ÿè¸ªå™¨ï¼ˆ`geometry.enabled: false`ï¼‰ï¼Œç³»ç»Ÿä¼šæ˜¾ç¤º ID ä¸”ä¿æŒè·ç¦»/é€Ÿåº¦ä¸º `None`ã€‚

------

# Module 7ï¼ˆå¯è§†åŒ–ä¸å‘Šè­¦ï¼‰

## âœ… å½“å‰å®ç°

- `src/vis/draw.py` æä¾›ç»Ÿä¸€çš„ç»˜åˆ¶å‡½æ•°ï¼ŒæŒ‰ç±»åˆ«è‡ªåŠ¨é…è‰²ï¼Œå åŠ è·Ÿè¸ª IDã€è·ç¦»ã€é€Ÿåº¦ã€‚
- `preview.compare` æ”¯æŒæ¨ª/çºµå‘å¯¹æ¯”åŸå§‹å¸§ä¸å¤„ç†å¸§ï¼Œå¯åœ¨ç”»é¢ä¸Šæ–¹/ä¸‹æ–¹æ˜¾ç¤º FPSã€‚
- å½•åƒè¾“å‡ºï¼ˆ`preview.record`ï¼‰å¯é€‰ï¼Œå°†å¯¹æ¯”ç”»é¢å¯¼å‡ºåˆ° MP4 æ–‡ä»¶ã€‚

## âš™ï¸ é…ç½®å…¥å£

```yaml
vis:
  draw:
    det: true          # æ§åˆ¶æ˜¯å¦ç»˜åˆ¶æ£€æµ‹æ¡†
    thickness: 2
    font_scale: 0.6
```

------

# Module 8ï¼ˆæ€§èƒ½ä¸å¼‚æ­¥æµæ°´çº¿ï¼‰

## âœ… å½“å‰å®ç°

- `src/runtime/async_pipeline.AsyncPipeline` æä¾›**é‡‡é›†çº¿ç¨‹ + æ¨ç†çº¿ç¨‹**çš„å¼‚æ­¥ç»„åˆï¼Œé¿å…æ‘„åƒå¤´è¯»å–é˜»å¡æ¨ç†ã€‚
- å¸§é˜Ÿåˆ—æ”¯æŒ `queue_size`ã€`drop_policy`ã€`max_latency_ms`ï¼Œåœ¨æ€§èƒ½ä¸è¶³æ—¶è‡ªåŠ¨ä¸¢å¼ƒæ—§å¸§æˆ–è·³å¸§ä¿æŒå®æ—¶æ€§ã€‚
- ä¸»å¾ªç¯è¯»å– `AsyncPipeline` è¾“å‡ºï¼Œå¯åœ¨é€€å‡ºæ—¶çœ‹åˆ°â€œä¸¢å¼ƒ/è·³è¿‡å¸§â€ç»Ÿè®¡ï¼Œä¾¿äºè¯„ä¼°ååè¡¨ç°ã€‚

## ğŸ”„ çƒ­æ›´æ–°

- æ–°å¢ `runtime.hot_reload` è½®è¯¢å™¨ï¼Œé»˜è®¤æ¯ 2 ç§’æ£€æµ‹é…ç½®æ–‡ä»¶æ”¹åŠ¨ã€‚è§¦å‘åè‡ªåŠ¨é‡å»ºç®¡çº¿ï¼ˆç›¸æœºã€æ¨ç†ã€æ¸²æŸ“ï¼‰ã€‚
- å¯åŠ¨å‘½ä»¤æ”¯æŒ `--config` æŒ‡å®šè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

  ```bash
  python main_preview.py --config configs/jetson.yaml
  ```

- ä¿®æ”¹ `configs/default.yaml` åï¼ˆå¦‚åˆ‡æ¢æ¨¡å‹é˜ˆå€¼ï¼‰ï¼Œæ— éœ€é‡å¯çª—å£å³å¯ç”Ÿæ•ˆã€‚

## âš™ï¸ é…ç½®ç‰‡æ®µ

```yaml
runtime:
  async:
    enabled: true          # æ‰“å¼€å¤šçº¿ç¨‹é‡‡é›†/æ¨ç†
    queue_size: 6          # ç¼“å­˜çš„å¸§æ•°
    drop_policy: "oldest"   # é˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒæœ€æ—§å¸§
    max_latency_ms: 200.0  # å¸§å»¶è¿Ÿè¶…è¿‡ 200ms è§†ä¸ºè¿‡æœŸ
    result_timeout_ms: 300.0
  hot_reload:
    enabled: true
    interval_sec: 2.0
```

> â„¹ï¸ è‹¥æƒ³ä¿ç•™â€œä¸¥æ ¼é€å¸§â€æ¨¡å¼ï¼Œå¯ä¿æŒ `runtime.async.enabled: false`ï¼Œç³»ç»Ÿä»æŒ‰å•çº¿ç¨‹é¡ºåºæ‰§è¡Œã€‚

------

# Module 9ï¼ˆJetson Nano éƒ¨ç½²å±‚ï¼‰

## âœ… å½“å‰å®ç°

- `camera.backend: "gstreamer"` è‡ªåŠ¨æ‹¼æ¥ `nvarguscamerasrc` ç®¡çº¿ï¼Œæˆ–ç›´æ¥å¡«å†™è‡ªå®šä¹‰ GStreamer å­—ç¬¦ä¸²ï¼Œå®ç° Jetson CSI æ‘„åƒå¤´é›¶æ‹·è´é‡‡é›†ã€‚
- æ–°å¢ TensorRT æ£€æµ‹åç«¯ï¼ˆ`detect.backend: "tensorrt"`ï¼‰ï¼Œå¤ç”¨ Ultralytics å¯¼å‡ºçš„ `.engine`ï¼Œæ”¯æŒ `imgsz`ã€`warmup_runs`ã€`half` ç­‰å‚æ•°ã€‚
- åŒä¸€ä»½é…ç½®å¯åœ¨ PC ä¸ Jetson é—´åˆ‡æ¢ï¼Œä»…éœ€è°ƒæ•´ `runtime.async` å’Œ TensorRT å¼•æ“è·¯å¾„ã€‚

## âš™ï¸ Jetson æ‘„åƒå¤´ç¤ºä¾‹

```yaml
camera:
  backend: "gstreamer"
  gstreamer:
    pipeline: ""  # ä¸ºç©ºæ—¶è‡ªåŠ¨ç”Ÿæˆ nvarguscamerasrc ç®¡çº¿
    sensor_id: 0
    capture_width: 1920
    capture_height: 1080
    display_width: 1280
    display_height: 720
    framerate: 30
    flip_method: 2
```

## âš™ï¸ TensorRT æ£€æµ‹ç¤ºä¾‹

```yaml
detect:
  enabled: true
  backend: "tensorrt"
  engine: "weights/yolov8n.engine"
  imgsz: 640
  half: true
  warmup_runs: 3
  classes_keep: [2, 3, 5, 7]
```

- ä½¿ç”¨ Ultralytics å¯¼å‡ºå¼•æ“ï¼š`yolo export model=yolov8n.pt format=engine half=True device=0`ã€‚
- Jetson Nano è‹¥åªå®‰è£… TensorRT runtimeï¼Œå¯åœ¨ `requirements.txt` åŸºç¡€ä¸Šé¢å¤–å®‰è£… `ultralytics` è½»é‡åŒ…ï¼Œæˆ–å¤åˆ¶è®­ç»ƒå¥½çš„ `.engine`ã€‚

------

# è¿è¡Œç¤ºä¾‹

```bash
python main_preview.py  # è¯»å–é»˜è®¤é…ç½®

# æˆ–è€…æŒ‡å®šè‡ªå®šä¹‰é…ç½®ï¼Œä¿æŒçƒ­æ›´æ–°
python main_preview.py --config configs/default.yaml
```

- é»˜è®¤è¯»å– `configs/default.yaml`ï¼Œå¦‚å¯ç”¨ `runtime.hot_reload.enabled: true`ï¼Œç¼–è¾‘æ–‡ä»¶åä¼šè‡ªåŠ¨é‡å¯ç®¡çº¿ã€‚
- ä¿è¯å·²å®‰è£…ä¾èµ–ï¼š`pip install -r requirements.txt`ï¼ˆåŒ…å« `filterpy`ã€`ultralytics` ç­‰ï¼‰ã€‚
- è¿è¡Œåçª—å£æ˜¾ç¤º RAW/PROC å¯¹æ¯”ï¼ŒæŒ‰ `q` æˆ– `Esc` é€€å‡ºã€‚

------

# æ ‡å®šå°è´´å£«

1. ä½¿ç”¨é™æ€å¸§ï¼ˆæˆªå±æˆ–å•å¸§ä¿å­˜ï¼‰æ ‡æ³¨åœ°é¢ä¸Šå·²çŸ¥è·ç¦»çš„ç‚¹ï¼Œä¾‹å¦‚åœè½¦çº¿ã€è½¦é“çº¿äº¤ç‚¹ã€‚
2. åœ¨ `image_points` ä¸­å¡«å…¥åƒç´ åæ ‡ï¼ˆå¯ç”¨ OpenCV `imshow` + é¼ æ ‡è·å–æˆ–å…¶ä»–å·¥å…·ï¼‰ï¼Œåœ¨ `world_points` å¡«å¯¹åº”å®é™…è·ç¦»ã€‚
3. å»ºè®®èµ·ç‚¹ `origin` è®¾ä¸ºæ‘„åƒæœºæŠ•å½±ç‚¹æˆ–è·¯å£é™„è¿‘çš„å›ºå®šå‚è€ƒç‚¹ï¼Œä¾¿äºè¯»æ•°ã€‚
4. `max_distance` å¯é˜²æ­¢è¿œå¤„å™ªç‚¹é€ æˆæç«¯é€Ÿåº¦å€¼ï¼Œå¯æ ¹æ®åœºæ™¯è°ƒæ•´ã€‚

------

# TODO / ä¸‹ä¸€æ­¥è®¡åˆ’

- Module 10ï¼šå¼•å…¥åœ¨çº¿å†è®­ç»ƒ/æ¨¡å‹è’¸é¦æ¥å£ï¼Œç»“åˆé“è·¯åœºæ™¯è‡ªé€‚åº”ã€‚
- Module 11ï¼šèåˆå¤šæ‘„åƒå¤´/å¤šè·¯ RTSP ç®¡çº¿çš„è°ƒåº¦ä¸åŒæ­¥å‘Šè­¦ã€‚

